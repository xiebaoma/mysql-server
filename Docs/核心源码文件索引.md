# MySQL 8.0 核心源码文件索引

本文档提供MySQL 8.0源码中关键文件的快速索引，帮助快速定位特定功能的实现。

## 一、目录结构概览

```
mysql-server/
├── sql/                          # SQL层核心代码（Server层）
│   ├── sql_parse.cc/h            # SQL解析和命令分发
│   ├── sql_optimizer.cc/h        # 查询优化器
│   ├── sql_select.cc/h           # SELECT语句执行
│   ├── sql_insert.cc/h           # INSERT语句执行
│   ├── sql_update.cc/h           # UPDATE语句执行
│   ├── sql_delete.cc/h           # DELETE语句执行
│   ├── sql_class.cc/h            # THD类和核心数据结构
│   ├── sql_lex.cc/h              # 词法分析器
│   ├── handler.cc/h              # 存储引擎接口
│   ├── protocol_classic.cc/h     # 客户端协议
│   ├── iterators/                # 执行器迭代器
│   └── join_optimizer/           # 超图优化器
│
├── storage/                      # 存储引擎
│   ├── innobase/                 # InnoDB存储引擎
│   │   ├── handler/              # Handler接口实现
│   │   ├── btr/                  # B+树实现
│   │   ├── row/                  # 行操作
│   │   ├── trx/                  # 事务管理
│   │   ├── lock/                 # 锁管理
│   │   └── buf/                  # Buffer Pool
│   ├── myisam/                   # MyISAM存储引擎
│   └── memory/                   # MEMORY存储引擎
│
├── include/                      # 公共头文件
│   ├── my_base.h                 # 基础定义
│   ├── mysql.h                   # 客户端API
│   └── mysql/                    # 组件服务接口
│
├── client/                       # 客户端工具
│   ├── mysql.cc                  # mysql命令行客户端
│   └── mysqldump.cc              # mysqldump工具
│
└── mysys/                        # 系统抽象层
    ├── my_alloc.cc               # 内存分配
    └── mf_cache.cc               # 文件缓存
```

## 二、核心功能文件索引

### 1. 连接和命令处理

#### sql/conn_handler/connection_handler_one_thread.cc
**功能**: 单线程连接处理器
```cpp
关键函数:
- handle_connection(THD *thd)           // 处理一个客户端连接
- thd_prepare_connection(THD *thd)      // 连接认证和初始化
```

#### sql/sql_connect.cc
**功能**: 连接管理和认证
```cpp
关键函数:
- check_connection(THD *thd)            // 检查连接
- login_connection(THD *thd)            // 登录处理
- prepare_new_connection_state(THD *thd) // 准备新连接状态
```

#### sql/sql_parse.cc (3000+ 行)
**功能**: SQL命令解析和分发的核心文件
```cpp
关键函数:
- do_command(THD *thd)                                    [行1308]
  作用: 从客户端读取命令的主循环
  
- dispatch_command(THD *thd, COM_DATA*, enum_server_command) [行1688]
  作用: 根据命令类型分发到不同处理函数
  
- dispatch_sql_command(THD *thd, Parser_state*)           [行5254]
  作用: SQL命令的统一入口，调用解析器和执行器
  
- mysql_execute_command(THD *thd, bool first_level)       [行2948]
  作用: 执行SQL命令的核心函数，巨大的switch语句
  
- execute_sqlcom_select(THD *thd, Table_ref *all_tables)  
  作用: 执行SELECT语句
  
- alloc_query(THD *thd, const char *query, size_t length)
  作用: 分配查询字符串内存
```

### 2. SQL解析器

#### sql/sql_yacc.yy (15000+ 行)
**功能**: YACC/Bison语法定义文件
```yacc
主要规则:
- query: select_stmt | insert_stmt | update_stmt | delete_stmt ...
- select_stmt: SELECT select_item_list FROM table_ref opt_where_clause
- table_ref: table_factor | joined_table
- expr: 各种表达式规则

生成: sql/sql_yacc.cc 和 sql/sql_yacc.h
```

#### sql/sql_lex.cc (5000+ 行)
**功能**: 词法分析器实现
```cpp
关键类和函数:
- class Lexer                           // 词法分析器主类
- Lexer::lex_one_token()                // 读取下一个token
- lex_start(THD *thd)                   // 初始化词法分析器
- lex_end(LEX *lex)                     // 清理词法分析器

关键token类型:
- SELECT_SYM, INSERT_SYM, UPDATE_SYM, DELETE_SYM
- IDENT (标识符), NUM (数字), TEXT_STRING (字符串)
```

#### sql/sql_lex.h
**功能**: LEX数据结构定义
```cpp
关键结构:
- class LEX                             // 词法分析结果
  成员:
  - enum_sql_command sql_command        // SQL命令类型
  - Query_block *query_block            // 查询块
  - Query_expression *unit              // 查询表达式树
  - Sql_cmd *m_sql_cmd                  // SQL命令对象
  
- enum enum_sql_command                 // SQL命令枚举
  - SQLCOM_SELECT, SQLCOM_INSERT, SQLCOM_UPDATE, SQLCOM_DELETE
  - SQLCOM_CREATE_TABLE, SQLCOM_DROP_TABLE
  - ... 100+ 命令类型
```

#### sql/parse_tree_nodes.cc/h
**功能**: 解析树节点定义和实现
```cpp
主要类:
- class Parse_tree_root                 // 解析树根节点
- class PT_query_specification          // SELECT查询
- class PT_table_factor_table_ident     // 表引用
- class PT_item_list                    // 项列表
```

#### sql/parser_service.cc
**功能**: 解析器服务接口（供插件使用）
```cpp
关键函数:
- mysql_parser_parse(THD *thd, LEX_CSTRING query)
  作用: 外部调用解析器的接口
```

### 3. 查询优化器

#### sql/sql_optimizer.cc (6000+ 行)
**功能**: 传统优化器实现
```cpp
关键函数:
- JOIN::optimize(bool finalize_access_paths)              [行337]
  作用: JOIN优化的主入口，协调各个优化阶段
  
- Optimize_table_order::choose_table_order()              
  作用: 选择表连接顺序（传统优化器）
  
- optimize_cond(THD *thd, Item *conds, ...)
  作用: 优化WHERE条件
  
- propagate_cond_constants()
  作用: 常量传播
```

#### sql/sql_optimizer.h
**功能**: 优化器相关数据结构
```cpp
关键类:
- class JOIN                            // JOIN操作管理
  成员:
  - THD *thd
  - Query_block *query_block
  - AccessPath *m_root_access_path      // 执行计划
  - RowIterator *m_root_iterator        // 执行迭代器
  - table_map const_table_map           // 常量表
  - uint const_tables                   // 常量表数量
```

#### sql/join_optimizer/join_optimizer.cc (7000+ 行)
**功能**: 超图优化器实现（MySQL 8.0新优化器）
```cpp
关键函数:
- AccessPath *FindBestQueryPlan(THD *thd, Query_block *query_block, ...) [行6392]
  作用: 使用超图优化器生成最优执行计划
  
- JoinHypergraph MakeJoinHypergraph(...)
  作用: 构建连接超图
  
- EnumerateAllConnectedPartitions(...)
  作用: 枚举所有连接顺序
  
- EstimateCost(AccessPath *path)
  作用: 估算访问路径的代价
```

#### sql/join_optimizer/make_join_hypergraph.cc
**功能**: 构建连接超图
```cpp
关键函数:
- MakeJoinHypergraph(THD *thd, ...)
  作用: 将Query_block转换为超图表示
```

#### sql/join_optimizer/access_path.h
**功能**: 访问路径定义
```cpp
关键结构:
- struct AccessPath                     // 访问路径节点
  - AccessPathType type                 // 路径类型
  - double num_output_rows              // 预估输出行数
  - double cost                         // 代价
  
- enum AccessPathType
  - TABLE_SCAN                          // 全表扫描
  - INDEX_SCAN                          // 索引扫描
  - REF                                 // 索引ref访问
  - NESTED_LOOP_JOIN                    // 嵌套循环连接
  - HASH_JOIN                           // 哈希连接
  - SORT                                // 排序
  - AGGREGATE                           // 聚合
  - ... 30+ 访问路径类型
```

#### sql/opt_range.cc (10000+ 行)
**功能**: 范围优化器（索引范围扫描）
```cpp
关键函数:
- get_mm_tree(RANGE_OPT_PARAM *param, Item *cond)
  作用: 从WHERE条件构建范围树
  
- SQL_SELECT::test_quick_select(...)
  作用: 测试是否可以使用索引快速访问
```

#### sql/opt_costmodel.cc
**功能**: 代价模型
```cpp
关键函数:
- Cost_model_server::row_evaluate_cost(double rows)
  作用: 计算行处理代价
  
- Cost_model_table::page_read_cost(double pages)
  作用: 计算页面读取代价
```

### 4. 查询执行器

#### sql/sql_select.cc (3000+ 行)
**功能**: SELECT语句执行
```cpp
关键函数:
- Query_block::optimize(THD *thd, bool finalize_access_paths) [行1986]
  作用: 查询块优化入口
  
- Query_block::prepare(THD *thd, mem_root_deque<Item *> *...)
  作用: 准备查询块
  
- setup_tables(THD *thd, ...)
  作用: 设置表结构信息
  
- setup_fields(THD *thd, ...)
  作用: 设置字段信息
```

#### sql/sql_union.cc (2000+ 行)
**功能**: UNION和查询表达式执行
```cpp
关键函数:
- Query_expression::execute(THD *thd)                     [行1821]
  作用: 执行查询表达式
  
- Query_expression::ExecuteIteratorQuery(THD *thd)        [行1681]
  作用: 使用迭代器执行查询（火山模型）
  
- Query_expression::optimize(...)
  作用: 优化查询表达式
```

#### sql/iterators/ (目录)
**功能**: 执行器迭代器实现（火山模型）

##### sql/iterators/row_iterator.h
```cpp
基类:
- class RowIterator                     // 迭代器抽象基类
  虚函数:
  - virtual int Init() = 0              // 初始化
  - virtual int Read() = 0              // 读取下一行
  - virtual void UnlockRow() = 0        // 解锁行
```

##### sql/iterators/basic_row_iterators.cc
```cpp
基本迭代器:
- class TableScanIterator               // 全表扫描
  - int Read()                          // 调用 ha_rnd_next()
  
- class IndexScanIterator               // 索引扫描
  - int Read()                          // 调用 ha_index_read() / ha_index_next()
  
- class RefIterator                     // 索引ref访问
  - int Read()                          // 使用索引查找
```

##### sql/iterators/composite_iterators.cc
```cpp
组合迭代器:
- class NestedLoopIterator              // 嵌套循环连接
  - int Read()                          // 外表循环 + 内表循环
  
- class HashJoinIterator                // 哈希连接
  - int Read()                          // Build phase + Probe phase
  
- class FilterIterator                  // 过滤器（WHERE条件）
  - int Read()                          // 读取并过滤行
```

##### sql/iterators/sorting_iterator.cc
```cpp
排序迭代器:
- class SortIterator                    // 排序（ORDER BY）
  - int Read()                          // 从排序结果读取
```

##### sql/iterators/aggregation_iterator.cc
```cpp
聚合迭代器:
- class AggregateIterator               // 聚合（GROUP BY）
  - int Read()                          // 计算聚合结果
```

#### sql/sql_executor.cc
**功能**: 执行器辅助函数
```cpp
关键函数:
- create_iterators(JOIN *join)
  作用: 从AccessPath创建迭代器树
  
- CreateIteratorFromAccessPath(...)
  作用: 根据AccessPath类型创建对应的迭代器
```

### 5. DML语句执行

#### sql/sql_insert.cc (3000+ 行)
**功能**: INSERT语句执行
```cpp
关键函数:
- mysql_insert(THD *thd, Table_ref *table_list)
  作用: INSERT语句的主入口
  
- Sql_cmd_insert::execute_inner(THD *thd)
  作用: 执行INSERT逻辑
  
- write_record(THD *thd, TABLE *table, COPY_INFO *info, ...)
  作用: 写入一条记录
```

#### sql/sql_update.cc (2000+ 行)
**功能**: UPDATE语句执行
```cpp
关键函数:
- mysql_update(THD *thd, Table_ref *tables, ...)
  作用: UPDATE语句的主入口
  
- Sql_cmd_update::execute_inner(THD *thd)
  作用: 执行UPDATE逻辑
```

#### sql/sql_delete.cc (2000+ 行)
**功能**: DELETE语句执行
```cpp
关键函数:
- mysql_delete(THD *thd, Table_ref *table_list, ...)
  作用: DELETE语句的主入口
  
- Sql_cmd_delete::execute_inner(THD *thd)
  作用: 执行DELETE逻辑
```

### 6. DDL语句执行

#### sql/sql_table.cc (10000+ 行)
**功能**: 表DDL操作
```cpp
关键函数:
- mysql_create_table(THD *thd, Table_ref *table, ...)
  作用: CREATE TABLE
  
- mysql_alter_table(THD *thd, const char *new_db, ...)
  作用: ALTER TABLE
  
- mysql_drop_table(THD *thd, Table_ref *tables, ...)
  作用: DROP TABLE
```

#### sql/sql_db.cc
**功能**: 数据库DDL操作
```cpp
关键函数:
- mysql_create_db(THD *thd, const char *db, ...)
  作用: CREATE DATABASE
  
- mysql_rm_db(THD *thd, const char *db, ...)
  作用: DROP DATABASE
```

### 7. 存储引擎接口

#### sql/handler.h (3000+ 行)
**功能**: 存储引擎抽象接口
```cpp
核心类:
- class handler                         // 存储引擎基类
  虚函数（存储引擎需实现）:
  - virtual int open(const char *name, ...)
  - virtual int close()
  - virtual int rnd_init(bool scan)     // 初始化全表扫描
  - virtual int rnd_next(uchar *buf)    // 读取下一行
  - virtual int index_init(uint idx, bool sorted) // 初始化索引扫描
  - virtual int index_read(...)         // 索引读取
  - virtual int index_next(uchar *buf)  // 索引下一行
  - virtual int write_row(uchar *buf)   // 插入行
  - virtual int update_row(const uchar *old_data, uchar *new_data) // 更新行
  - virtual int delete_row(const uchar *buf) // 删除行
  - virtual int start_stmt(THD *thd, ...)    // 开始语句
  - virtual THR_LOCK_DATA **store_lock(...) // 表锁
```

#### sql/handler.cc (8000+ 行)
**功能**: handler接口的公共实现
```cpp
关键函数:
- handler::ha_open(TABLE *table_arg, ...)
  作用: 打开表的公共逻辑（调用存储引擎的open）
  
- handler::ha_rnd_next(uchar *buf)
  作用: 全表扫描下一行的公共包装
  
- handler::ha_index_read_map(...)
  作用: 索引读取的公共包装
  
- handler::ha_write_row(uchar *buf)
  作用: 插入行的公共包装（事务、触发器等）
```

### 8. InnoDB存储引擎

#### storage/innobase/handler/ha_innodb.cc (20000+ 行)
**功能**: InnoDB的handler接口实现
```cpp
关键类:
- class ha_innobase : public handler   // InnoDB handler实现

关键函数:
- ha_innobase::open(const char *name, ...)           [行4200+]
  作用: 打开InnoDB表
  
- ha_innobase::rnd_init(bool scan)
  作用: 初始化全表扫描
  
- ha_innobase::rnd_next(uchar *buf)                  [行9300+]
  作用: 全表扫描下一行
  
- ha_innobase::index_init(uint keynr, bool sorted)
  作用: 初始化索引扫描
  
- ha_innobase::index_read(uchar *buf, ...)           [行9800+]
  作用: 索引查找
  
- ha_innobase::index_next(uchar *buf)                [行10000+]
  作用: 索引扫描下一行
  
- ha_innobase::write_row(uchar *record)              [行7500+]
  作用: 插入行
  
- ha_innobase::update_row(const uchar *old_row, uchar *new_row) [行8000+]
  作用: 更新行
  
- ha_innobase::delete_row(const uchar *record)       [行8200+]
  作用: 删除行
  
- ha_innobase::start_stmt(THD *thd, ...)
  作用: 开始语句（保存点）
  
- ha_innobase::external_lock(THD *thd, int lock_type)
  作用: 表锁/事务开始
```

#### storage/innobase/row/row0sel.cc (5000+ 行)
**功能**: InnoDB行查询实现
```cpp
关键函数:
- row_search_mvcc(uchar *buf, page_cur_mode_t mode, ...) [行4000+]
  作用: InnoDB MVCC查询的核心函数
  流程:
  1. 定位游标位置（B+树搜索）
  2. 读取记录
  3. MVCC可见性判断
  4. 如果可见，转换为MySQL格式返回
  5. 如果不可见，读取下一条
```

#### storage/innobase/btr/btr0cur.cc (6000+ 行)
**功能**: InnoDB B+树游标操作
```cpp
关键函数:
- btr_cur_search_to_nth_level(...)
  作用: 在B+树中搜索到指定层级
  
- btr_cur_open_at_index_side(...)
  作用: 打开B+树游标
  
- btr_cur_optimistic_insert(...)
  作用: 乐观插入（不分裂页面）
```

#### storage/innobase/btr/btr0btr.cc (4000+ 行)
**功能**: InnoDB B+树实现
```cpp
关键函数:
- btr_page_split_and_insert(...)
  作用: 页面分裂和插入
  
- btr_lift_page_up(...)
  作用: 页面上提（合并）
```

#### storage/innobase/buf/buf0buf.cc (5000+ 行)
**功能**: InnoDB Buffer Pool
```cpp
关键函数:
- buf_page_get_gen(...)
  作用: 从Buffer Pool获取页面（核心）
  流程:
  1. 在Buffer Pool中查找
  2. 如果找到，返回页面
  3. 如果未找到，从磁盘读取
  
- buf_page_io_complete(...)
  作用: IO完成后的处理
```

#### storage/innobase/trx/trx0trx.cc (3000+ 行)
**功能**: InnoDB事务管理
```cpp
关键函数:
- trx_start_low(trx_t *trx, bool read_write)
  作用: 开始事务
  
- trx_commit(trx_t *trx)
  作用: 提交事务
  
- trx_rollback_to_savepoint(...)
  作用: 回滚到保存点
```

#### storage/innobase/lock/lock0lock.cc (7000+ 行)
**功能**: InnoDB锁管理
```cpp
关键函数:
- lock_rec_lock(...)
  作用: 加行锁
  
- lock_table(...)
  作用: 加表锁
  
- lock_clust_rec_cons_read_sees(...)
  作用: MVCC可见性判断
```

### 9. 客户端协议

#### sql/protocol_classic.cc (2000+ 行)
**功能**: MySQL客户端/服务器协议实现
```cpp
关键类:
- class Protocol_classic : public Protocol

关键函数:
- Protocol_classic::get_command(COM_DATA *com_data, ...)
  作用: 从客户端读取命令
  
- Protocol_classic::send_result_set_metadata(...)
  作用: 发送结果集元数据（列定义）
  
- Protocol_classic::send_result_set_row(...)
  作用: 发送结果集的一行
  
- Protocol_classic::send_eof(...)
  作用: 发送EOF包（查询结束）
  
- Protocol_classic::send_error(...)
  作用: 发送错误包
```

#### sql/protocol_classic.h
```cpp
协议常量:
- COM_SLEEP, COM_QUIT, COM_INIT_DB
- COM_QUERY                             // 普通查询
- COM_STMT_PREPARE                      // 预处理准备
- COM_STMT_EXECUTE                      // 预处理执行
- COM_STMT_CLOSE                        // 预处理关闭
```

#### vio/viosocket.c
**功能**: 虚拟IO层（网络抽象）
```cpp
关键函数:
- vio_read(Vio *vio, uchar *buf, size_t size)
  作用: 从socket读取
  
- vio_write(Vio *vio, const uchar *buf, size_t size)
  作用: 向socket写入
```

### 10. 核心数据结构

#### sql/sql_class.h (5000+ 行)
**功能**: THD和核心类定义
```cpp
核心类:
- class THD                             // 线程句柄（最重要的类）
  主要成员:
  - LEX *lex                            // 词法分析结果
  - Protocol *protocol                  // 客户端协议
  - Security_context *security_ctx      // 安全上下文
  - Transaction_state transaction       // 事务状态
  - Diagnostics_area *stmt_da           // 诊断区域
  - Query_arena *query_arena            // 查询内存arena
  - TABLE *open_tables                  // 打开的表链表
  - MDL_context mdl_context             // 元数据锁上下文
  - ... 300+ 成员变量
  
  主要方法:
  - bool sql_parser()                   // 调用解析器
  - void send_result_set_row(...)       // 发送结果行
  - bool send_result_metadata(...)      // 发送元数据
```

#### sql/table.h (3000+ 行)
**功能**: 表相关数据结构
```cpp
关键类:
- class TABLE                           // 表实例
  成员:
  - TABLE_SHARE *s                      // 表定义共享信息
  - handler *file                       // 存储引擎handler
  - uchar *record[2]                    // 记录缓冲区
  - Field **field                       // 字段数组
  - KEY *key_info                       // 索引信息
  
- class TABLE_SHARE                     // 表定义（共享）
  成员:
  - char *table_name                    // 表名
  - uint fields                         // 字段数
  - uint keys                           // 索引数
  - KEY *key_info                       // 索引定义
  
- class Table_ref                       // 表引用（FROM子句）
  成员:
  - const char *table_name              // 表名
  - const char *db                      // 数据库名
  - TABLE *table                        // TABLE实例指针
```

#### sql/field.h (2000+ 行)
**功能**: 字段类型定义
```cpp
类层次:
- class Field                           // 字段基类
  - class Field_num                     // 数值字段
    - class Field_tiny                  // TINYINT
    - class Field_short                 // SMALLINT
    - class Field_long                  // INT
    - class Field_longlong              // BIGINT
  - class Field_str                     // 字符串字段
    - class Field_string                // CHAR
    - class Field_varstring             // VARCHAR
    - class Field_blob                  // TEXT/BLOB
  - class Field_temporal                // 时间字段
    - class Field_datetime              // DATETIME
    - class Field_timestamp             // TIMESTAMP
```

#### sql/item.h (3000+ 行)
**功能**: 表达式节点（WHERE、SELECT等）
```cpp
类层次:
- class Item                            // 表达式基类
  - class Item_field                    // 字段引用
  - class Item_int                      // 整数常量
  - class Item_string                   // 字符串常量
  - class Item_func                     // 函数
    - class Item_func_eq                // = 操作符
    - class Item_func_lt                // < 操作符
    - class Item_func_plus              // + 操作符
    - class Item_sum                    // 聚合函数
      - class Item_sum_count            // COUNT()
      - class Item_sum_sum              // SUM()
```

### 11. 事务和锁

#### sql/transaction.cc
**功能**: 事务管理（Server层）
```cpp
关键函数:
- trans_begin(THD *thd, uint flags)
  作用: 开始事务
  
- trans_commit(THD *thd)
  作用: 提交事务
  
- trans_rollback(THD *thd)
  作用: 回滚事务
  
- trans_commit_stmt(THD *thd)
  作用: 提交语句
```

#### sql/mdl.cc (8000+ 行)
**功能**: 元数据锁（Metadata Lock）
```cpp
关键类:
- class MDL_context                     // MDL上下文
- class MDL_request                     // MDL请求
- class MDL_ticket                      // MDL票据

关键函数:
- MDL_context::acquire_lock(...)
  作用: 获取元数据锁
  
- MDL_context::release_lock(...)
  作用: 释放元数据锁
```

### 12. 日志和复制

#### sql/log.cc (10000+ 行)
**功能**: 通用日志、慢查询日志
```cpp
关键类:
- class Query_logger                    // 查询日志记录器

关键函数:
- Query_logger::general_log_write(...)
  作用: 写通用日志
  
- Query_logger::slow_log_write(...)
  作用: 写慢查询日志
```

#### sql/binlog.cc (10000+ 行)
**功能**: 二进制日志（Binlog）
```cpp
关键类:
- class MYSQL_BIN_LOG                   // Binlog类

关键函数:
- MYSQL_BIN_LOG::write_event(Log_event *event)
  作用: 写binlog事件
  
- MYSQL_BIN_LOG::commit(...)
  作用: 提交事务到binlog
```

#### sql/rpl_replica.cc (8000+ 行)
**功能**: 主从复制（Slave端）
```cpp
关键函数:
- handle_slave_sql(void *arg)
  作用: SQL线程主函数
  
- handle_slave_io(void *arg)
  作用: IO线程主函数
  
- exec_relay_log_event(...)
  作用: 执行relay log事件
```

### 13. 性能监控

#### sql/sql_profile.cc
**功能**: SQL Profiling
```cpp
关键类:
- class PROFILING                       // Profiling管理器
- class QUERY_PROFILE                   // 单个查询的profile

关键函数:
- PROFILING::start_new_query(...)
  作用: 开始新查询的profiling
  
- PROFILING::finish_current_query()
  作用: 结束当前查询的profiling
```

#### storage/perfschema/ (目录)
**功能**: Performance Schema
```cpp
核心表:
- events_statements_current             // 当前语句
- events_statements_history             // 语句历史
- table_io_waits_summary_by_table       // 表IO等待统计
```

## 三、按功能查找代码

### 如何查找某个SQL语句的实现？

1. **在 sql/sql_parse.cc 的 mysql_execute_command() 中找switch分支**
2. **查找对应的 SQLCOM_XXX case**
3. **跟踪调用的函数（如 mysql_insert, mysql_update等）**

示例：
```cpp
// 查找 ALTER TABLE 的实现
sql/sql_parse.cc:
  mysql_execute_command() {
    switch (lex->sql_command) {
      case SQLCOM_ALTER_TABLE:
        res = Sql_cmd_alter_table::execute(thd);
        → 进入 sql/sql_alter.cc
    }
  }
```

### 如何查找某个函数的实现？

1. **SUM() → Item_sum_sum → sql/item_sum.cc**
2. **MAX() → Item_sum_max → sql/item_sum.cc**
3. **CONCAT() → Item_func_concat → sql/item_strfunc.cc**
4. **NOW() → Item_func_now_local → sql/item_timefunc.cc**

### 如何查找存储引擎的实现？

1. **InnoDB: storage/innobase/**
   - handler实现: handler/ha_innodb.cc
   - B+树: btr/btr0cur.cc, btr/btr0btr.cc
   - 事务: trx/trx0trx.cc
   - 锁: lock/lock0lock.cc

2. **MyISAM: storage/myisam/**
   - handler实现: ha_myisam.cc

3. **MEMORY: storage/heap/**
   - handler实现: ha_heap.cc

### 如何查找优化器的实现？

1. **传统优化器: sql/sql_optimizer.cc**
2. **超图优化器: sql/join_optimizer/**
3. **范围优化: sql/opt_range.cc**
4. **代价模型: sql/opt_costmodel.cc**

## 四、调试技巧

### GDB常用断点

```bash
# 命令入口
b do_command
b dispatch_command

# 解析器
b parse_sql
b MYSQLparse
b lex_one_token

# 优化器
b JOIN::optimize
b FindBestQueryPlan
b get_mm_tree

# 执行器
b Query_expression::ExecuteIteratorQuery
b RowIterator::Read

# 存储引擎
b ha_innobase::rnd_next
b ha_innobase::index_read
b row_search_mvcc

# 协议
b Protocol_classic::send_result_set_row
b net_write_packet
```

### 查看调用堆栈

```bash
# GDB
(gdb) bt          # backtrace
(gdb) bt full     # 带局部变量

# 或在代码中打印
#include "my_stacktrace.h"
my_print_stacktrace(nullptr, 0);
```

### 打印变量

```cpp
// 在代码中添加
DBUG_PRINT("info", ("query: %s", thd->query().str));
LogErr(INFORMATION_LEVEL, ER_UNKNOWN_ERROR, "Debug info");
```

## 五、编译和调试

### 编译带调试信息的MySQL

```bash
cmake . -DWITH_DEBUG=1 \
        -DCMAKE_BUILD_TYPE=Debug \
        -DWITH_ASAN=ON \
        -DWITH_UBSAN=ON

make -j8
```

### 运行单元测试

```bash
# 运行所有测试
make test

# 运行特定测试
./mtr --suite=main --do-test=select
```

## 六、总结

MySQL 8.0的代码组织清晰：
- **sql/** - Server层（SQL解析、优化、执行）
- **storage/** - 存储引擎层（数据存储和检索）
- **include/** - 公共接口
- **mysys/** - 系统抽象层

掌握这些关键文件的位置，可以快速定位问题和理解实现细节。

建议学习顺序：
1. **sql/sql_parse.cc** - 理解整体流程
2. **sql/sql_lex.cc/h** - 理解解析
3. **sql/sql_optimizer.cc** - 理解优化
4. **sql/sql_union.cc** - 理解执行
5. **storage/innobase/** - 理解存储引擎

Happy hacking! 🚀

