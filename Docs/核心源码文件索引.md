# MySQL 8.0 æ ¸å¿ƒæºç æ–‡ä»¶ç´¢å¼•

æœ¬æ–‡æ¡£æä¾›MySQL 8.0æºç ä¸­å…³é”®æ–‡ä»¶çš„å¿«é€Ÿç´¢å¼•ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½ç‰¹å®šåŠŸèƒ½çš„å®ç°ã€‚

## ä¸€ã€ç›®å½•ç»“æ„æ¦‚è§ˆ

```
mysql-server/
â”œâ”€â”€ sql/                          # SQLå±‚æ ¸å¿ƒä»£ç ï¼ˆServerå±‚ï¼‰
â”‚   â”œâ”€â”€ sql_parse.cc/h            # SQLè§£æå’Œå‘½ä»¤åˆ†å‘
â”‚   â”œâ”€â”€ sql_optimizer.cc/h        # æŸ¥è¯¢ä¼˜åŒ–å™¨
â”‚   â”œâ”€â”€ sql_select.cc/h           # SELECTè¯­å¥æ‰§è¡Œ
â”‚   â”œâ”€â”€ sql_insert.cc/h           # INSERTè¯­å¥æ‰§è¡Œ
â”‚   â”œâ”€â”€ sql_update.cc/h           # UPDATEè¯­å¥æ‰§è¡Œ
â”‚   â”œâ”€â”€ sql_delete.cc/h           # DELETEè¯­å¥æ‰§è¡Œ
â”‚   â”œâ”€â”€ sql_class.cc/h            # THDç±»å’Œæ ¸å¿ƒæ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ sql_lex.cc/h              # è¯æ³•åˆ†æå™¨
â”‚   â”œâ”€â”€ handler.cc/h              # å­˜å‚¨å¼•æ“æ¥å£
â”‚   â”œâ”€â”€ protocol_classic.cc/h     # å®¢æˆ·ç«¯åè®®
â”‚   â”œâ”€â”€ iterators/                # æ‰§è¡Œå™¨è¿­ä»£å™¨
â”‚   â””â”€â”€ join_optimizer/           # è¶…å›¾ä¼˜åŒ–å™¨
â”‚
â”œâ”€â”€ storage/                      # å­˜å‚¨å¼•æ“
â”‚   â”œâ”€â”€ innobase/                 # InnoDBå­˜å‚¨å¼•æ“
â”‚   â”‚   â”œâ”€â”€ handler/              # Handleræ¥å£å®ç°
â”‚   â”‚   â”œâ”€â”€ btr/                  # B+æ ‘å®ç°
â”‚   â”‚   â”œâ”€â”€ row/                  # è¡Œæ“ä½œ
â”‚   â”‚   â”œâ”€â”€ trx/                  # äº‹åŠ¡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ lock/                 # é”ç®¡ç†
â”‚   â”‚   â””â”€â”€ buf/                  # Buffer Pool
â”‚   â”œâ”€â”€ myisam/                   # MyISAMå­˜å‚¨å¼•æ“
â”‚   â””â”€â”€ memory/                   # MEMORYå­˜å‚¨å¼•æ“
â”‚
â”œâ”€â”€ include/                      # å…¬å…±å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ my_base.h                 # åŸºç¡€å®šä¹‰
â”‚   â”œâ”€â”€ mysql.h                   # å®¢æˆ·ç«¯API
â”‚   â””â”€â”€ mysql/                    # ç»„ä»¶æœåŠ¡æ¥å£
â”‚
â”œâ”€â”€ client/                       # å®¢æˆ·ç«¯å·¥å…·
â”‚   â”œâ”€â”€ mysql.cc                  # mysqlå‘½ä»¤è¡Œå®¢æˆ·ç«¯
â”‚   â””â”€â”€ mysqldump.cc              # mysqldumpå·¥å…·
â”‚
â””â”€â”€ mysys/                        # ç³»ç»ŸæŠ½è±¡å±‚
    â”œâ”€â”€ my_alloc.cc               # å†…å­˜åˆ†é…
    â””â”€â”€ mf_cache.cc               # æ–‡ä»¶ç¼“å­˜
```

## äºŒã€æ ¸å¿ƒåŠŸèƒ½æ–‡ä»¶ç´¢å¼•

### 1. è¿æ¥å’Œå‘½ä»¤å¤„ç†

#### sql/conn_handler/connection_handler_one_thread.cc
**åŠŸèƒ½**: å•çº¿ç¨‹è¿æ¥å¤„ç†å™¨
```cpp
å…³é”®å‡½æ•°:
- handle_connection(THD *thd)           // å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
- thd_prepare_connection(THD *thd)      // è¿æ¥è®¤è¯å’Œåˆå§‹åŒ–
```

#### sql/sql_connect.cc
**åŠŸèƒ½**: è¿æ¥ç®¡ç†å’Œè®¤è¯
```cpp
å…³é”®å‡½æ•°:
- check_connection(THD *thd)            // æ£€æŸ¥è¿æ¥
- login_connection(THD *thd)            // ç™»å½•å¤„ç†
- prepare_new_connection_state(THD *thd) // å‡†å¤‡æ–°è¿æ¥çŠ¶æ€
```

#### sql/sql_parse.cc (3000+ è¡Œ)
**åŠŸèƒ½**: SQLå‘½ä»¤è§£æå’Œåˆ†å‘çš„æ ¸å¿ƒæ–‡ä»¶
```cpp
å…³é”®å‡½æ•°:
- do_command(THD *thd)                                    [è¡Œ1308]
  ä½œç”¨: ä»å®¢æˆ·ç«¯è¯»å–å‘½ä»¤çš„ä¸»å¾ªç¯
  
- dispatch_command(THD *thd, COM_DATA*, enum_server_command) [è¡Œ1688]
  ä½œç”¨: æ ¹æ®å‘½ä»¤ç±»å‹åˆ†å‘åˆ°ä¸åŒå¤„ç†å‡½æ•°
  
- dispatch_sql_command(THD *thd, Parser_state*)           [è¡Œ5254]
  ä½œç”¨: SQLå‘½ä»¤çš„ç»Ÿä¸€å…¥å£ï¼Œè°ƒç”¨è§£æå™¨å’Œæ‰§è¡Œå™¨
  
- mysql_execute_command(THD *thd, bool first_level)       [è¡Œ2948]
  ä½œç”¨: æ‰§è¡ŒSQLå‘½ä»¤çš„æ ¸å¿ƒå‡½æ•°ï¼Œå·¨å¤§çš„switchè¯­å¥
  
- execute_sqlcom_select(THD *thd, Table_ref *all_tables)  
  ä½œç”¨: æ‰§è¡ŒSELECTè¯­å¥
  
- alloc_query(THD *thd, const char *query, size_t length)
  ä½œç”¨: åˆ†é…æŸ¥è¯¢å­—ç¬¦ä¸²å†…å­˜
```

### 2. SQLè§£æå™¨

#### sql/sql_yacc.yy (15000+ è¡Œ)
**åŠŸèƒ½**: YACC/Bisonè¯­æ³•å®šä¹‰æ–‡ä»¶
```yacc
ä¸»è¦è§„åˆ™:
- query: select_stmt | insert_stmt | update_stmt | delete_stmt ...
- select_stmt: SELECT select_item_list FROM table_ref opt_where_clause
- table_ref: table_factor | joined_table
- expr: å„ç§è¡¨è¾¾å¼è§„åˆ™

ç”Ÿæˆ: sql/sql_yacc.cc å’Œ sql/sql_yacc.h
```

#### sql/sql_lex.cc (5000+ è¡Œ)
**åŠŸèƒ½**: è¯æ³•åˆ†æå™¨å®ç°
```cpp
å…³é”®ç±»å’Œå‡½æ•°:
- class Lexer                           // è¯æ³•åˆ†æå™¨ä¸»ç±»
- Lexer::lex_one_token()                // è¯»å–ä¸‹ä¸€ä¸ªtoken
- lex_start(THD *thd)                   // åˆå§‹åŒ–è¯æ³•åˆ†æå™¨
- lex_end(LEX *lex)                     // æ¸…ç†è¯æ³•åˆ†æå™¨

å…³é”®tokenç±»å‹:
- SELECT_SYM, INSERT_SYM, UPDATE_SYM, DELETE_SYM
- IDENT (æ ‡è¯†ç¬¦), NUM (æ•°å­—), TEXT_STRING (å­—ç¬¦ä¸²)
```

#### sql/sql_lex.h
**åŠŸèƒ½**: LEXæ•°æ®ç»“æ„å®šä¹‰
```cpp
å…³é”®ç»“æ„:
- class LEX                             // è¯æ³•åˆ†æç»“æœ
  æˆå‘˜:
  - enum_sql_command sql_command        // SQLå‘½ä»¤ç±»å‹
  - Query_block *query_block            // æŸ¥è¯¢å—
  - Query_expression *unit              // æŸ¥è¯¢è¡¨è¾¾å¼æ ‘
  - Sql_cmd *m_sql_cmd                  // SQLå‘½ä»¤å¯¹è±¡
  
- enum enum_sql_command                 // SQLå‘½ä»¤æšä¸¾
  - SQLCOM_SELECT, SQLCOM_INSERT, SQLCOM_UPDATE, SQLCOM_DELETE
  - SQLCOM_CREATE_TABLE, SQLCOM_DROP_TABLE
  - ... 100+ å‘½ä»¤ç±»å‹
```

#### sql/parse_tree_nodes.cc/h
**åŠŸèƒ½**: è§£ææ ‘èŠ‚ç‚¹å®šä¹‰å’Œå®ç°
```cpp
ä¸»è¦ç±»:
- class Parse_tree_root                 // è§£ææ ‘æ ¹èŠ‚ç‚¹
- class PT_query_specification          // SELECTæŸ¥è¯¢
- class PT_table_factor_table_ident     // è¡¨å¼•ç”¨
- class PT_item_list                    // é¡¹åˆ—è¡¨
```

#### sql/parser_service.cc
**åŠŸèƒ½**: è§£æå™¨æœåŠ¡æ¥å£ï¼ˆä¾›æ’ä»¶ä½¿ç”¨ï¼‰
```cpp
å…³é”®å‡½æ•°:
- mysql_parser_parse(THD *thd, LEX_CSTRING query)
  ä½œç”¨: å¤–éƒ¨è°ƒç”¨è§£æå™¨çš„æ¥å£
```

### 3. æŸ¥è¯¢ä¼˜åŒ–å™¨

#### sql/sql_optimizer.cc (6000+ è¡Œ)
**åŠŸèƒ½**: ä¼ ç»Ÿä¼˜åŒ–å™¨å®ç°
```cpp
å…³é”®å‡½æ•°:
- JOIN::optimize(bool finalize_access_paths)              [è¡Œ337]
  ä½œç”¨: JOINä¼˜åŒ–çš„ä¸»å…¥å£ï¼Œåè°ƒå„ä¸ªä¼˜åŒ–é˜¶æ®µ
  
- Optimize_table_order::choose_table_order()              
  ä½œç”¨: é€‰æ‹©è¡¨è¿æ¥é¡ºåºï¼ˆä¼ ç»Ÿä¼˜åŒ–å™¨ï¼‰
  
- optimize_cond(THD *thd, Item *conds, ...)
  ä½œç”¨: ä¼˜åŒ–WHEREæ¡ä»¶
  
- propagate_cond_constants()
  ä½œç”¨: å¸¸é‡ä¼ æ’­
```

#### sql/sql_optimizer.h
**åŠŸèƒ½**: ä¼˜åŒ–å™¨ç›¸å…³æ•°æ®ç»“æ„
```cpp
å…³é”®ç±»:
- class JOIN                            // JOINæ“ä½œç®¡ç†
  æˆå‘˜:
  - THD *thd
  - Query_block *query_block
  - AccessPath *m_root_access_path      // æ‰§è¡Œè®¡åˆ’
  - RowIterator *m_root_iterator        // æ‰§è¡Œè¿­ä»£å™¨
  - table_map const_table_map           // å¸¸é‡è¡¨
  - uint const_tables                   // å¸¸é‡è¡¨æ•°é‡
```

#### sql/join_optimizer/join_optimizer.cc (7000+ è¡Œ)
**åŠŸèƒ½**: è¶…å›¾ä¼˜åŒ–å™¨å®ç°ï¼ˆMySQL 8.0æ–°ä¼˜åŒ–å™¨ï¼‰
```cpp
å…³é”®å‡½æ•°:
- AccessPath *FindBestQueryPlan(THD *thd, Query_block *query_block, ...) [è¡Œ6392]
  ä½œç”¨: ä½¿ç”¨è¶…å›¾ä¼˜åŒ–å™¨ç”Ÿæˆæœ€ä¼˜æ‰§è¡Œè®¡åˆ’
  
- JoinHypergraph MakeJoinHypergraph(...)
  ä½œç”¨: æ„å»ºè¿æ¥è¶…å›¾
  
- EnumerateAllConnectedPartitions(...)
  ä½œç”¨: æšä¸¾æ‰€æœ‰è¿æ¥é¡ºåº
  
- EstimateCost(AccessPath *path)
  ä½œç”¨: ä¼°ç®—è®¿é—®è·¯å¾„çš„ä»£ä»·
```

#### sql/join_optimizer/make_join_hypergraph.cc
**åŠŸèƒ½**: æ„å»ºè¿æ¥è¶…å›¾
```cpp
å…³é”®å‡½æ•°:
- MakeJoinHypergraph(THD *thd, ...)
  ä½œç”¨: å°†Query_blockè½¬æ¢ä¸ºè¶…å›¾è¡¨ç¤º
```

#### sql/join_optimizer/access_path.h
**åŠŸèƒ½**: è®¿é—®è·¯å¾„å®šä¹‰
```cpp
å…³é”®ç»“æ„:
- struct AccessPath                     // è®¿é—®è·¯å¾„èŠ‚ç‚¹
  - AccessPathType type                 // è·¯å¾„ç±»å‹
  - double num_output_rows              // é¢„ä¼°è¾“å‡ºè¡Œæ•°
  - double cost                         // ä»£ä»·
  
- enum AccessPathType
  - TABLE_SCAN                          // å…¨è¡¨æ‰«æ
  - INDEX_SCAN                          // ç´¢å¼•æ‰«æ
  - REF                                 // ç´¢å¼•refè®¿é—®
  - NESTED_LOOP_JOIN                    // åµŒå¥—å¾ªç¯è¿æ¥
  - HASH_JOIN                           // å“ˆå¸Œè¿æ¥
  - SORT                                // æ’åº
  - AGGREGATE                           // èšåˆ
  - ... 30+ è®¿é—®è·¯å¾„ç±»å‹
```

#### sql/opt_range.cc (10000+ è¡Œ)
**åŠŸèƒ½**: èŒƒå›´ä¼˜åŒ–å™¨ï¼ˆç´¢å¼•èŒƒå›´æ‰«æï¼‰
```cpp
å…³é”®å‡½æ•°:
- get_mm_tree(RANGE_OPT_PARAM *param, Item *cond)
  ä½œç”¨: ä»WHEREæ¡ä»¶æ„å»ºèŒƒå›´æ ‘
  
- SQL_SELECT::test_quick_select(...)
  ä½œç”¨: æµ‹è¯•æ˜¯å¦å¯ä»¥ä½¿ç”¨ç´¢å¼•å¿«é€Ÿè®¿é—®
```

#### sql/opt_costmodel.cc
**åŠŸèƒ½**: ä»£ä»·æ¨¡å‹
```cpp
å…³é”®å‡½æ•°:
- Cost_model_server::row_evaluate_cost(double rows)
  ä½œç”¨: è®¡ç®—è¡Œå¤„ç†ä»£ä»·
  
- Cost_model_table::page_read_cost(double pages)
  ä½œç”¨: è®¡ç®—é¡µé¢è¯»å–ä»£ä»·
```

### 4. æŸ¥è¯¢æ‰§è¡Œå™¨

#### sql/sql_select.cc (3000+ è¡Œ)
**åŠŸèƒ½**: SELECTè¯­å¥æ‰§è¡Œ
```cpp
å…³é”®å‡½æ•°:
- Query_block::optimize(THD *thd, bool finalize_access_paths) [è¡Œ1986]
  ä½œç”¨: æŸ¥è¯¢å—ä¼˜åŒ–å…¥å£
  
- Query_block::prepare(THD *thd, mem_root_deque<Item *> *...)
  ä½œç”¨: å‡†å¤‡æŸ¥è¯¢å—
  
- setup_tables(THD *thd, ...)
  ä½œç”¨: è®¾ç½®è¡¨ç»“æ„ä¿¡æ¯
  
- setup_fields(THD *thd, ...)
  ä½œç”¨: è®¾ç½®å­—æ®µä¿¡æ¯
```

#### sql/sql_union.cc (2000+ è¡Œ)
**åŠŸèƒ½**: UNIONå’ŒæŸ¥è¯¢è¡¨è¾¾å¼æ‰§è¡Œ
```cpp
å…³é”®å‡½æ•°:
- Query_expression::execute(THD *thd)                     [è¡Œ1821]
  ä½œç”¨: æ‰§è¡ŒæŸ¥è¯¢è¡¨è¾¾å¼
  
- Query_expression::ExecuteIteratorQuery(THD *thd)        [è¡Œ1681]
  ä½œç”¨: ä½¿ç”¨è¿­ä»£å™¨æ‰§è¡ŒæŸ¥è¯¢ï¼ˆç«å±±æ¨¡å‹ï¼‰
  
- Query_expression::optimize(...)
  ä½œç”¨: ä¼˜åŒ–æŸ¥è¯¢è¡¨è¾¾å¼
```

#### sql/iterators/ (ç›®å½•)
**åŠŸèƒ½**: æ‰§è¡Œå™¨è¿­ä»£å™¨å®ç°ï¼ˆç«å±±æ¨¡å‹ï¼‰

##### sql/iterators/row_iterator.h
```cpp
åŸºç±»:
- class RowIterator                     // è¿­ä»£å™¨æŠ½è±¡åŸºç±»
  è™šå‡½æ•°:
  - virtual int Init() = 0              // åˆå§‹åŒ–
  - virtual int Read() = 0              // è¯»å–ä¸‹ä¸€è¡Œ
  - virtual void UnlockRow() = 0        // è§£é”è¡Œ
```

##### sql/iterators/basic_row_iterators.cc
```cpp
åŸºæœ¬è¿­ä»£å™¨:
- class TableScanIterator               // å…¨è¡¨æ‰«æ
  - int Read()                          // è°ƒç”¨ ha_rnd_next()
  
- class IndexScanIterator               // ç´¢å¼•æ‰«æ
  - int Read()                          // è°ƒç”¨ ha_index_read() / ha_index_next()
  
- class RefIterator                     // ç´¢å¼•refè®¿é—®
  - int Read()                          // ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾
```

##### sql/iterators/composite_iterators.cc
```cpp
ç»„åˆè¿­ä»£å™¨:
- class NestedLoopIterator              // åµŒå¥—å¾ªç¯è¿æ¥
  - int Read()                          // å¤–è¡¨å¾ªç¯ + å†…è¡¨å¾ªç¯
  
- class HashJoinIterator                // å“ˆå¸Œè¿æ¥
  - int Read()                          // Build phase + Probe phase
  
- class FilterIterator                  // è¿‡æ»¤å™¨ï¼ˆWHEREæ¡ä»¶ï¼‰
  - int Read()                          // è¯»å–å¹¶è¿‡æ»¤è¡Œ
```

##### sql/iterators/sorting_iterator.cc
```cpp
æ’åºè¿­ä»£å™¨:
- class SortIterator                    // æ’åºï¼ˆORDER BYï¼‰
  - int Read()                          // ä»æ’åºç»“æœè¯»å–
```

##### sql/iterators/aggregation_iterator.cc
```cpp
èšåˆè¿­ä»£å™¨:
- class AggregateIterator               // èšåˆï¼ˆGROUP BYï¼‰
  - int Read()                          // è®¡ç®—èšåˆç»“æœ
```

#### sql/sql_executor.cc
**åŠŸèƒ½**: æ‰§è¡Œå™¨è¾…åŠ©å‡½æ•°
```cpp
å…³é”®å‡½æ•°:
- create_iterators(JOIN *join)
  ä½œç”¨: ä»AccessPathåˆ›å»ºè¿­ä»£å™¨æ ‘
  
- CreateIteratorFromAccessPath(...)
  ä½œç”¨: æ ¹æ®AccessPathç±»å‹åˆ›å»ºå¯¹åº”çš„è¿­ä»£å™¨
```

### 5. DMLè¯­å¥æ‰§è¡Œ

#### sql/sql_insert.cc (3000+ è¡Œ)
**åŠŸèƒ½**: INSERTè¯­å¥æ‰§è¡Œ
```cpp
å…³é”®å‡½æ•°:
- mysql_insert(THD *thd, Table_ref *table_list)
  ä½œç”¨: INSERTè¯­å¥çš„ä¸»å…¥å£
  
- Sql_cmd_insert::execute_inner(THD *thd)
  ä½œç”¨: æ‰§è¡ŒINSERTé€»è¾‘
  
- write_record(THD *thd, TABLE *table, COPY_INFO *info, ...)
  ä½œç”¨: å†™å…¥ä¸€æ¡è®°å½•
```

#### sql/sql_update.cc (2000+ è¡Œ)
**åŠŸèƒ½**: UPDATEè¯­å¥æ‰§è¡Œ
```cpp
å…³é”®å‡½æ•°:
- mysql_update(THD *thd, Table_ref *tables, ...)
  ä½œç”¨: UPDATEè¯­å¥çš„ä¸»å…¥å£
  
- Sql_cmd_update::execute_inner(THD *thd)
  ä½œç”¨: æ‰§è¡ŒUPDATEé€»è¾‘
```

#### sql/sql_delete.cc (2000+ è¡Œ)
**åŠŸèƒ½**: DELETEè¯­å¥æ‰§è¡Œ
```cpp
å…³é”®å‡½æ•°:
- mysql_delete(THD *thd, Table_ref *table_list, ...)
  ä½œç”¨: DELETEè¯­å¥çš„ä¸»å…¥å£
  
- Sql_cmd_delete::execute_inner(THD *thd)
  ä½œç”¨: æ‰§è¡ŒDELETEé€»è¾‘
```

### 6. DDLè¯­å¥æ‰§è¡Œ

#### sql/sql_table.cc (10000+ è¡Œ)
**åŠŸèƒ½**: è¡¨DDLæ“ä½œ
```cpp
å…³é”®å‡½æ•°:
- mysql_create_table(THD *thd, Table_ref *table, ...)
  ä½œç”¨: CREATE TABLE
  
- mysql_alter_table(THD *thd, const char *new_db, ...)
  ä½œç”¨: ALTER TABLE
  
- mysql_drop_table(THD *thd, Table_ref *tables, ...)
  ä½œç”¨: DROP TABLE
```

#### sql/sql_db.cc
**åŠŸèƒ½**: æ•°æ®åº“DDLæ“ä½œ
```cpp
å…³é”®å‡½æ•°:
- mysql_create_db(THD *thd, const char *db, ...)
  ä½œç”¨: CREATE DATABASE
  
- mysql_rm_db(THD *thd, const char *db, ...)
  ä½œç”¨: DROP DATABASE
```

### 7. å­˜å‚¨å¼•æ“æ¥å£

#### sql/handler.h (3000+ è¡Œ)
**åŠŸèƒ½**: å­˜å‚¨å¼•æ“æŠ½è±¡æ¥å£
```cpp
æ ¸å¿ƒç±»:
- class handler                         // å­˜å‚¨å¼•æ“åŸºç±»
  è™šå‡½æ•°ï¼ˆå­˜å‚¨å¼•æ“éœ€å®ç°ï¼‰:
  - virtual int open(const char *name, ...)
  - virtual int close()
  - virtual int rnd_init(bool scan)     // åˆå§‹åŒ–å…¨è¡¨æ‰«æ
  - virtual int rnd_next(uchar *buf)    // è¯»å–ä¸‹ä¸€è¡Œ
  - virtual int index_init(uint idx, bool sorted) // åˆå§‹åŒ–ç´¢å¼•æ‰«æ
  - virtual int index_read(...)         // ç´¢å¼•è¯»å–
  - virtual int index_next(uchar *buf)  // ç´¢å¼•ä¸‹ä¸€è¡Œ
  - virtual int write_row(uchar *buf)   // æ’å…¥è¡Œ
  - virtual int update_row(const uchar *old_data, uchar *new_data) // æ›´æ–°è¡Œ
  - virtual int delete_row(const uchar *buf) // åˆ é™¤è¡Œ
  - virtual int start_stmt(THD *thd, ...)    // å¼€å§‹è¯­å¥
  - virtual THR_LOCK_DATA **store_lock(...) // è¡¨é”
```

#### sql/handler.cc (8000+ è¡Œ)
**åŠŸèƒ½**: handleræ¥å£çš„å…¬å…±å®ç°
```cpp
å…³é”®å‡½æ•°:
- handler::ha_open(TABLE *table_arg, ...)
  ä½œç”¨: æ‰“å¼€è¡¨çš„å…¬å…±é€»è¾‘ï¼ˆè°ƒç”¨å­˜å‚¨å¼•æ“çš„openï¼‰
  
- handler::ha_rnd_next(uchar *buf)
  ä½œç”¨: å…¨è¡¨æ‰«æä¸‹ä¸€è¡Œçš„å…¬å…±åŒ…è£…
  
- handler::ha_index_read_map(...)
  ä½œç”¨: ç´¢å¼•è¯»å–çš„å…¬å…±åŒ…è£…
  
- handler::ha_write_row(uchar *buf)
  ä½œç”¨: æ’å…¥è¡Œçš„å…¬å…±åŒ…è£…ï¼ˆäº‹åŠ¡ã€è§¦å‘å™¨ç­‰ï¼‰
```

### 8. InnoDBå­˜å‚¨å¼•æ“

#### storage/innobase/handler/ha_innodb.cc (20000+ è¡Œ)
**åŠŸèƒ½**: InnoDBçš„handleræ¥å£å®ç°
```cpp
å…³é”®ç±»:
- class ha_innobase : public handler   // InnoDB handlerå®ç°

å…³é”®å‡½æ•°:
- ha_innobase::open(const char *name, ...)           [è¡Œ4200+]
  ä½œç”¨: æ‰“å¼€InnoDBè¡¨
  
- ha_innobase::rnd_init(bool scan)
  ä½œç”¨: åˆå§‹åŒ–å…¨è¡¨æ‰«æ
  
- ha_innobase::rnd_next(uchar *buf)                  [è¡Œ9300+]
  ä½œç”¨: å…¨è¡¨æ‰«æä¸‹ä¸€è¡Œ
  
- ha_innobase::index_init(uint keynr, bool sorted)
  ä½œç”¨: åˆå§‹åŒ–ç´¢å¼•æ‰«æ
  
- ha_innobase::index_read(uchar *buf, ...)           [è¡Œ9800+]
  ä½œç”¨: ç´¢å¼•æŸ¥æ‰¾
  
- ha_innobase::index_next(uchar *buf)                [è¡Œ10000+]
  ä½œç”¨: ç´¢å¼•æ‰«æä¸‹ä¸€è¡Œ
  
- ha_innobase::write_row(uchar *record)              [è¡Œ7500+]
  ä½œç”¨: æ’å…¥è¡Œ
  
- ha_innobase::update_row(const uchar *old_row, uchar *new_row) [è¡Œ8000+]
  ä½œç”¨: æ›´æ–°è¡Œ
  
- ha_innobase::delete_row(const uchar *record)       [è¡Œ8200+]
  ä½œç”¨: åˆ é™¤è¡Œ
  
- ha_innobase::start_stmt(THD *thd, ...)
  ä½œç”¨: å¼€å§‹è¯­å¥ï¼ˆä¿å­˜ç‚¹ï¼‰
  
- ha_innobase::external_lock(THD *thd, int lock_type)
  ä½œç”¨: è¡¨é”/äº‹åŠ¡å¼€å§‹
```

#### storage/innobase/row/row0sel.cc (5000+ è¡Œ)
**åŠŸèƒ½**: InnoDBè¡ŒæŸ¥è¯¢å®ç°
```cpp
å…³é”®å‡½æ•°:
- row_search_mvcc(uchar *buf, page_cur_mode_t mode, ...) [è¡Œ4000+]
  ä½œç”¨: InnoDB MVCCæŸ¥è¯¢çš„æ ¸å¿ƒå‡½æ•°
  æµç¨‹:
  1. å®šä½æ¸¸æ ‡ä½ç½®ï¼ˆB+æ ‘æœç´¢ï¼‰
  2. è¯»å–è®°å½•
  3. MVCCå¯è§æ€§åˆ¤æ–­
  4. å¦‚æœå¯è§ï¼Œè½¬æ¢ä¸ºMySQLæ ¼å¼è¿”å›
  5. å¦‚æœä¸å¯è§ï¼Œè¯»å–ä¸‹ä¸€æ¡
```

#### storage/innobase/btr/btr0cur.cc (6000+ è¡Œ)
**åŠŸèƒ½**: InnoDB B+æ ‘æ¸¸æ ‡æ“ä½œ
```cpp
å…³é”®å‡½æ•°:
- btr_cur_search_to_nth_level(...)
  ä½œç”¨: åœ¨B+æ ‘ä¸­æœç´¢åˆ°æŒ‡å®šå±‚çº§
  
- btr_cur_open_at_index_side(...)
  ä½œç”¨: æ‰“å¼€B+æ ‘æ¸¸æ ‡
  
- btr_cur_optimistic_insert(...)
  ä½œç”¨: ä¹è§‚æ’å…¥ï¼ˆä¸åˆ†è£‚é¡µé¢ï¼‰
```

#### storage/innobase/btr/btr0btr.cc (4000+ è¡Œ)
**åŠŸèƒ½**: InnoDB B+æ ‘å®ç°
```cpp
å…³é”®å‡½æ•°:
- btr_page_split_and_insert(...)
  ä½œç”¨: é¡µé¢åˆ†è£‚å’Œæ’å…¥
  
- btr_lift_page_up(...)
  ä½œç”¨: é¡µé¢ä¸Šæï¼ˆåˆå¹¶ï¼‰
```

#### storage/innobase/buf/buf0buf.cc (5000+ è¡Œ)
**åŠŸèƒ½**: InnoDB Buffer Pool
```cpp
å…³é”®å‡½æ•°:
- buf_page_get_gen(...)
  ä½œç”¨: ä»Buffer Poolè·å–é¡µé¢ï¼ˆæ ¸å¿ƒï¼‰
  æµç¨‹:
  1. åœ¨Buffer Poolä¸­æŸ¥æ‰¾
  2. å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›é¡µé¢
  3. å¦‚æœæœªæ‰¾åˆ°ï¼Œä»ç£ç›˜è¯»å–
  
- buf_page_io_complete(...)
  ä½œç”¨: IOå®Œæˆåçš„å¤„ç†
```

#### storage/innobase/trx/trx0trx.cc (3000+ è¡Œ)
**åŠŸèƒ½**: InnoDBäº‹åŠ¡ç®¡ç†
```cpp
å…³é”®å‡½æ•°:
- trx_start_low(trx_t *trx, bool read_write)
  ä½œç”¨: å¼€å§‹äº‹åŠ¡
  
- trx_commit(trx_t *trx)
  ä½œç”¨: æäº¤äº‹åŠ¡
  
- trx_rollback_to_savepoint(...)
  ä½œç”¨: å›æ»šåˆ°ä¿å­˜ç‚¹
```

#### storage/innobase/lock/lock0lock.cc (7000+ è¡Œ)
**åŠŸèƒ½**: InnoDBé”ç®¡ç†
```cpp
å…³é”®å‡½æ•°:
- lock_rec_lock(...)
  ä½œç”¨: åŠ è¡Œé”
  
- lock_table(...)
  ä½œç”¨: åŠ è¡¨é”
  
- lock_clust_rec_cons_read_sees(...)
  ä½œç”¨: MVCCå¯è§æ€§åˆ¤æ–­
```

### 9. å®¢æˆ·ç«¯åè®®

#### sql/protocol_classic.cc (2000+ è¡Œ)
**åŠŸèƒ½**: MySQLå®¢æˆ·ç«¯/æœåŠ¡å™¨åè®®å®ç°
```cpp
å…³é”®ç±»:
- class Protocol_classic : public Protocol

å…³é”®å‡½æ•°:
- Protocol_classic::get_command(COM_DATA *com_data, ...)
  ä½œç”¨: ä»å®¢æˆ·ç«¯è¯»å–å‘½ä»¤
  
- Protocol_classic::send_result_set_metadata(...)
  ä½œç”¨: å‘é€ç»“æœé›†å…ƒæ•°æ®ï¼ˆåˆ—å®šä¹‰ï¼‰
  
- Protocol_classic::send_result_set_row(...)
  ä½œç”¨: å‘é€ç»“æœé›†çš„ä¸€è¡Œ
  
- Protocol_classic::send_eof(...)
  ä½œç”¨: å‘é€EOFåŒ…ï¼ˆæŸ¥è¯¢ç»“æŸï¼‰
  
- Protocol_classic::send_error(...)
  ä½œç”¨: å‘é€é”™è¯¯åŒ…
```

#### sql/protocol_classic.h
```cpp
åè®®å¸¸é‡:
- COM_SLEEP, COM_QUIT, COM_INIT_DB
- COM_QUERY                             // æ™®é€šæŸ¥è¯¢
- COM_STMT_PREPARE                      // é¢„å¤„ç†å‡†å¤‡
- COM_STMT_EXECUTE                      // é¢„å¤„ç†æ‰§è¡Œ
- COM_STMT_CLOSE                        // é¢„å¤„ç†å…³é—­
```

#### vio/viosocket.c
**åŠŸèƒ½**: è™šæ‹ŸIOå±‚ï¼ˆç½‘ç»œæŠ½è±¡ï¼‰
```cpp
å…³é”®å‡½æ•°:
- vio_read(Vio *vio, uchar *buf, size_t size)
  ä½œç”¨: ä»socketè¯»å–
  
- vio_write(Vio *vio, const uchar *buf, size_t size)
  ä½œç”¨: å‘socketå†™å…¥
```

### 10. æ ¸å¿ƒæ•°æ®ç»“æ„

#### sql/sql_class.h (5000+ è¡Œ)
**åŠŸèƒ½**: THDå’Œæ ¸å¿ƒç±»å®šä¹‰
```cpp
æ ¸å¿ƒç±»:
- class THD                             // çº¿ç¨‹å¥æŸ„ï¼ˆæœ€é‡è¦çš„ç±»ï¼‰
  ä¸»è¦æˆå‘˜:
  - LEX *lex                            // è¯æ³•åˆ†æç»“æœ
  - Protocol *protocol                  // å®¢æˆ·ç«¯åè®®
  - Security_context *security_ctx      // å®‰å…¨ä¸Šä¸‹æ–‡
  - Transaction_state transaction       // äº‹åŠ¡çŠ¶æ€
  - Diagnostics_area *stmt_da           // è¯Šæ–­åŒºåŸŸ
  - Query_arena *query_arena            // æŸ¥è¯¢å†…å­˜arena
  - TABLE *open_tables                  // æ‰“å¼€çš„è¡¨é“¾è¡¨
  - MDL_context mdl_context             // å…ƒæ•°æ®é”ä¸Šä¸‹æ–‡
  - ... 300+ æˆå‘˜å˜é‡
  
  ä¸»è¦æ–¹æ³•:
  - bool sql_parser()                   // è°ƒç”¨è§£æå™¨
  - void send_result_set_row(...)       // å‘é€ç»“æœè¡Œ
  - bool send_result_metadata(...)      // å‘é€å…ƒæ•°æ®
```

#### sql/table.h (3000+ è¡Œ)
**åŠŸèƒ½**: è¡¨ç›¸å…³æ•°æ®ç»“æ„
```cpp
å…³é”®ç±»:
- class TABLE                           // è¡¨å®ä¾‹
  æˆå‘˜:
  - TABLE_SHARE *s                      // è¡¨å®šä¹‰å…±äº«ä¿¡æ¯
  - handler *file                       // å­˜å‚¨å¼•æ“handler
  - uchar *record[2]                    // è®°å½•ç¼“å†²åŒº
  - Field **field                       // å­—æ®µæ•°ç»„
  - KEY *key_info                       // ç´¢å¼•ä¿¡æ¯
  
- class TABLE_SHARE                     // è¡¨å®šä¹‰ï¼ˆå…±äº«ï¼‰
  æˆå‘˜:
  - char *table_name                    // è¡¨å
  - uint fields                         // å­—æ®µæ•°
  - uint keys                           // ç´¢å¼•æ•°
  - KEY *key_info                       // ç´¢å¼•å®šä¹‰
  
- class Table_ref                       // è¡¨å¼•ç”¨ï¼ˆFROMå­å¥ï¼‰
  æˆå‘˜:
  - const char *table_name              // è¡¨å
  - const char *db                      // æ•°æ®åº“å
  - TABLE *table                        // TABLEå®ä¾‹æŒ‡é’ˆ
```

#### sql/field.h (2000+ è¡Œ)
**åŠŸèƒ½**: å­—æ®µç±»å‹å®šä¹‰
```cpp
ç±»å±‚æ¬¡:
- class Field                           // å­—æ®µåŸºç±»
  - class Field_num                     // æ•°å€¼å­—æ®µ
    - class Field_tiny                  // TINYINT
    - class Field_short                 // SMALLINT
    - class Field_long                  // INT
    - class Field_longlong              // BIGINT
  - class Field_str                     // å­—ç¬¦ä¸²å­—æ®µ
    - class Field_string                // CHAR
    - class Field_varstring             // VARCHAR
    - class Field_blob                  // TEXT/BLOB
  - class Field_temporal                // æ—¶é—´å­—æ®µ
    - class Field_datetime              // DATETIME
    - class Field_timestamp             // TIMESTAMP
```

#### sql/item.h (3000+ è¡Œ)
**åŠŸèƒ½**: è¡¨è¾¾å¼èŠ‚ç‚¹ï¼ˆWHEREã€SELECTç­‰ï¼‰
```cpp
ç±»å±‚æ¬¡:
- class Item                            // è¡¨è¾¾å¼åŸºç±»
  - class Item_field                    // å­—æ®µå¼•ç”¨
  - class Item_int                      // æ•´æ•°å¸¸é‡
  - class Item_string                   // å­—ç¬¦ä¸²å¸¸é‡
  - class Item_func                     // å‡½æ•°
    - class Item_func_eq                // = æ“ä½œç¬¦
    - class Item_func_lt                // < æ“ä½œç¬¦
    - class Item_func_plus              // + æ“ä½œç¬¦
    - class Item_sum                    // èšåˆå‡½æ•°
      - class Item_sum_count            // COUNT()
      - class Item_sum_sum              // SUM()
```

### 11. äº‹åŠ¡å’Œé”

#### sql/transaction.cc
**åŠŸèƒ½**: äº‹åŠ¡ç®¡ç†ï¼ˆServerå±‚ï¼‰
```cpp
å…³é”®å‡½æ•°:
- trans_begin(THD *thd, uint flags)
  ä½œç”¨: å¼€å§‹äº‹åŠ¡
  
- trans_commit(THD *thd)
  ä½œç”¨: æäº¤äº‹åŠ¡
  
- trans_rollback(THD *thd)
  ä½œç”¨: å›æ»šäº‹åŠ¡
  
- trans_commit_stmt(THD *thd)
  ä½œç”¨: æäº¤è¯­å¥
```

#### sql/mdl.cc (8000+ è¡Œ)
**åŠŸèƒ½**: å…ƒæ•°æ®é”ï¼ˆMetadata Lockï¼‰
```cpp
å…³é”®ç±»:
- class MDL_context                     // MDLä¸Šä¸‹æ–‡
- class MDL_request                     // MDLè¯·æ±‚
- class MDL_ticket                      // MDLç¥¨æ®

å…³é”®å‡½æ•°:
- MDL_context::acquire_lock(...)
  ä½œç”¨: è·å–å…ƒæ•°æ®é”
  
- MDL_context::release_lock(...)
  ä½œç”¨: é‡Šæ”¾å…ƒæ•°æ®é”
```

### 12. æ—¥å¿—å’Œå¤åˆ¶

#### sql/log.cc (10000+ è¡Œ)
**åŠŸèƒ½**: é€šç”¨æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—
```cpp
å…³é”®ç±»:
- class Query_logger                    // æŸ¥è¯¢æ—¥å¿—è®°å½•å™¨

å…³é”®å‡½æ•°:
- Query_logger::general_log_write(...)
  ä½œç”¨: å†™é€šç”¨æ—¥å¿—
  
- Query_logger::slow_log_write(...)
  ä½œç”¨: å†™æ…¢æŸ¥è¯¢æ—¥å¿—
```

#### sql/binlog.cc (10000+ è¡Œ)
**åŠŸèƒ½**: äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinlogï¼‰
```cpp
å…³é”®ç±»:
- class MYSQL_BIN_LOG                   // Binlogç±»

å…³é”®å‡½æ•°:
- MYSQL_BIN_LOG::write_event(Log_event *event)
  ä½œç”¨: å†™binlogäº‹ä»¶
  
- MYSQL_BIN_LOG::commit(...)
  ä½œç”¨: æäº¤äº‹åŠ¡åˆ°binlog
```

#### sql/rpl_replica.cc (8000+ è¡Œ)
**åŠŸèƒ½**: ä¸»ä»å¤åˆ¶ï¼ˆSlaveç«¯ï¼‰
```cpp
å…³é”®å‡½æ•°:
- handle_slave_sql(void *arg)
  ä½œç”¨: SQLçº¿ç¨‹ä¸»å‡½æ•°
  
- handle_slave_io(void *arg)
  ä½œç”¨: IOçº¿ç¨‹ä¸»å‡½æ•°
  
- exec_relay_log_event(...)
  ä½œç”¨: æ‰§è¡Œrelay logäº‹ä»¶
```

### 13. æ€§èƒ½ç›‘æ§

#### sql/sql_profile.cc
**åŠŸèƒ½**: SQL Profiling
```cpp
å…³é”®ç±»:
- class PROFILING                       // Profilingç®¡ç†å™¨
- class QUERY_PROFILE                   // å•ä¸ªæŸ¥è¯¢çš„profile

å…³é”®å‡½æ•°:
- PROFILING::start_new_query(...)
  ä½œç”¨: å¼€å§‹æ–°æŸ¥è¯¢çš„profiling
  
- PROFILING::finish_current_query()
  ä½œç”¨: ç»“æŸå½“å‰æŸ¥è¯¢çš„profiling
```

#### storage/perfschema/ (ç›®å½•)
**åŠŸèƒ½**: Performance Schema
```cpp
æ ¸å¿ƒè¡¨:
- events_statements_current             // å½“å‰è¯­å¥
- events_statements_history             // è¯­å¥å†å²
- table_io_waits_summary_by_table       // è¡¨IOç­‰å¾…ç»Ÿè®¡
```

## ä¸‰ã€æŒ‰åŠŸèƒ½æŸ¥æ‰¾ä»£ç 

### å¦‚ä½•æŸ¥æ‰¾æŸä¸ªSQLè¯­å¥çš„å®ç°ï¼Ÿ

1. **åœ¨ sql/sql_parse.cc çš„ mysql_execute_command() ä¸­æ‰¾switchåˆ†æ”¯**
2. **æŸ¥æ‰¾å¯¹åº”çš„ SQLCOM_XXX case**
3. **è·Ÿè¸ªè°ƒç”¨çš„å‡½æ•°ï¼ˆå¦‚ mysql_insert, mysql_updateç­‰ï¼‰**

ç¤ºä¾‹ï¼š
```cpp
// æŸ¥æ‰¾ ALTER TABLE çš„å®ç°
sql/sql_parse.cc:
  mysql_execute_command() {
    switch (lex->sql_command) {
      case SQLCOM_ALTER_TABLE:
        res = Sql_cmd_alter_table::execute(thd);
        â†’ è¿›å…¥ sql/sql_alter.cc
    }
  }
```

### å¦‚ä½•æŸ¥æ‰¾æŸä¸ªå‡½æ•°çš„å®ç°ï¼Ÿ

1. **SUM() â†’ Item_sum_sum â†’ sql/item_sum.cc**
2. **MAX() â†’ Item_sum_max â†’ sql/item_sum.cc**
3. **CONCAT() â†’ Item_func_concat â†’ sql/item_strfunc.cc**
4. **NOW() â†’ Item_func_now_local â†’ sql/item_timefunc.cc**

### å¦‚ä½•æŸ¥æ‰¾å­˜å‚¨å¼•æ“çš„å®ç°ï¼Ÿ

1. **InnoDB: storage/innobase/**
   - handlerå®ç°: handler/ha_innodb.cc
   - B+æ ‘: btr/btr0cur.cc, btr/btr0btr.cc
   - äº‹åŠ¡: trx/trx0trx.cc
   - é”: lock/lock0lock.cc

2. **MyISAM: storage/myisam/**
   - handlerå®ç°: ha_myisam.cc

3. **MEMORY: storage/heap/**
   - handlerå®ç°: ha_heap.cc

### å¦‚ä½•æŸ¥æ‰¾ä¼˜åŒ–å™¨çš„å®ç°ï¼Ÿ

1. **ä¼ ç»Ÿä¼˜åŒ–å™¨: sql/sql_optimizer.cc**
2. **è¶…å›¾ä¼˜åŒ–å™¨: sql/join_optimizer/**
3. **èŒƒå›´ä¼˜åŒ–: sql/opt_range.cc**
4. **ä»£ä»·æ¨¡å‹: sql/opt_costmodel.cc**

## å››ã€è°ƒè¯•æŠ€å·§

### GDBå¸¸ç”¨æ–­ç‚¹

```bash
# å‘½ä»¤å…¥å£
b do_command
b dispatch_command

# è§£æå™¨
b parse_sql
b MYSQLparse
b lex_one_token

# ä¼˜åŒ–å™¨
b JOIN::optimize
b FindBestQueryPlan
b get_mm_tree

# æ‰§è¡Œå™¨
b Query_expression::ExecuteIteratorQuery
b RowIterator::Read

# å­˜å‚¨å¼•æ“
b ha_innobase::rnd_next
b ha_innobase::index_read
b row_search_mvcc

# åè®®
b Protocol_classic::send_result_set_row
b net_write_packet
```

### æŸ¥çœ‹è°ƒç”¨å †æ ˆ

```bash
# GDB
(gdb) bt          # backtrace
(gdb) bt full     # å¸¦å±€éƒ¨å˜é‡

# æˆ–åœ¨ä»£ç ä¸­æ‰“å°
#include "my_stacktrace.h"
my_print_stacktrace(nullptr, 0);
```

### æ‰“å°å˜é‡

```cpp
// åœ¨ä»£ç ä¸­æ·»åŠ 
DBUG_PRINT("info", ("query: %s", thd->query().str));
LogErr(INFORMATION_LEVEL, ER_UNKNOWN_ERROR, "Debug info");
```

## äº”ã€ç¼–è¯‘å’Œè°ƒè¯•

### ç¼–è¯‘å¸¦è°ƒè¯•ä¿¡æ¯çš„MySQL

```bash
cmake . -DWITH_DEBUG=1 \
        -DCMAKE_BUILD_TYPE=Debug \
        -DWITH_ASAN=ON \
        -DWITH_UBSAN=ON

make -j8
```

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡Œç‰¹å®šæµ‹è¯•
./mtr --suite=main --do-test=select
```

## å…­ã€æ€»ç»“

MySQL 8.0çš„ä»£ç ç»„ç»‡æ¸…æ™°ï¼š
- **sql/** - Serverå±‚ï¼ˆSQLè§£æã€ä¼˜åŒ–ã€æ‰§è¡Œï¼‰
- **storage/** - å­˜å‚¨å¼•æ“å±‚ï¼ˆæ•°æ®å­˜å‚¨å’Œæ£€ç´¢ï¼‰
- **include/** - å…¬å…±æ¥å£
- **mysys/** - ç³»ç»ŸæŠ½è±¡å±‚

æŒæ¡è¿™äº›å…³é”®æ–‡ä»¶çš„ä½ç½®ï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜å’Œç†è§£å®ç°ç»†èŠ‚ã€‚

å»ºè®®å­¦ä¹ é¡ºåºï¼š
1. **sql/sql_parse.cc** - ç†è§£æ•´ä½“æµç¨‹
2. **sql/sql_lex.cc/h** - ç†è§£è§£æ
3. **sql/sql_optimizer.cc** - ç†è§£ä¼˜åŒ–
4. **sql/sql_union.cc** - ç†è§£æ‰§è¡Œ
5. **storage/innobase/** - ç†è§£å­˜å‚¨å¼•æ“

Happy hacking! ğŸš€

